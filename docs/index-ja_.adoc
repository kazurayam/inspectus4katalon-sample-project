
= Visual Inspection : Webサイトの画面確認を自動化しよう

== はじめに

わたしはWebアプリケーションのUIをテストとする作業をソフトウェアで自動化する技術に関心があります。わたしは2018年9月に下記の記事をQiitaに投稿しました。


* link:https://qiita.com/kazurayam/items/bcf72a03f50fc5db4373[Katalon StudioでVisual Testingを実現した]

このとき実装したコードにいろいろ不満があった。わたしは開発を続けました。もう４年も経った。ようやく実用レベルのツールを仕上げることができたのでここで紹介します。このツールを _Visual Inspection_ と名付けます。

== Visual Inspectionが出力するレポートのサンプル

Visual Inspectionを実行するとどういう出力が得られるのか？サンプルがあります。下記リンクをクリックして眺めてください。

- link:https://kazurayam.github.io/inspectus4katalon-sample-project/demo/store/index.html[store/index]

このサンプルをブラウザで開きあちこち眺める様子を動画にしてみました。

<iframe width="560" height="315" src="https://www.youtube.com/embed/pxZRS5-rigM" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

このレポートの見方をざっと説明しましょう。

=== 二つの画像の差分

上記URLが見せるサンプルの一つは、あるWebページのスクリーンショットを撮り、数秒後にもう一度スクリーンショットを撮って、二つの画像をピクセル単位で比較した結果の画像を見せている。食い違っているピクセルが赤色に塗られてハイライトされている。

image:https://kazurayam.github.io/inspectus4katalon-sample-project/images/Left-Diff-Right.png[]

題材にしたWebページ http://demoaut-mimic.kazurayam.com/ にはリクエストした時点の現在時刻が秒単位で表示されている。適当に間隔をおいて2回目のリクエストをすれば秒が変化するので差分画像の中にわずかながら赤い塗りつぶしが必ず生じる。その様子をデモしている。

あなたのWebサイトを標的としてVisual Inspectionを実施したら、どのページのどの箇所が赤くなるだろうか？ --- それはやってみなければわからない。ぜひ自分で試してみてください。

=== 二つのテキストの差分

題材にしたWebページ <http://demoaut-mimic.kazurayam.com/> のスクリーンショットで赤い塗り潰しを見つけて「おや？これはどうしたことか」と気づいたら、テスト担当者は次にWebページのHTMLソースコードのどこがどのように変化したのかを確かめたくなるだろう。そこでデモはWebページのHTMLソースをブラウザから取り出して記録として保存しています。下記の画像は二つのHTMLのdiffを表示している例です。

image:https://kazurayam.github.io/inspectus4katalon-sample-project/images/HTMLsource_diff.png[]

ブラウザに表示されたWebページのHTMLソースコードを事例として示したが他の形式のテキストも差分検査の対象とすることができる。JSON、XML、CSVといったデータ記述向きのテキストはもちろん、`.js` や `.css` のようなプログラム・コードもテキストに過ぎないのでInspectionの対象とすることができる。Webサイトからテキストファイルをダウンロードしていったんディスクに保存する、それを二度やって、後で二つのファイルを比較して差分を検査することができる。

=== diff ratio, FileType, Metadata

二つのファイルと差分ファイルをまとめた組のことを link:https://github.com/kazurayam/materialstore/blob/main/src/main/java/com/kazurayam/materialstore/base/reduce/zipper/MaterialProduct.java[MaterialProduct] というclassで表します。レポートの中に下記のような表示がありますが、これは Material Product の属性情報です。

image:https://kazurayam.github.io/inspectus4katalon-sample-project/images/diffratio-fileType-metadata.png[width=60%]

左上の `0.14%` という数字を **diff ratio** と呼びます。画面の四角形全体の大きさを100.00%として、赤く塗られた差分箇所が何パーセントを占めているかを表しています。"0.14%"という例は "完全に同じではない、ちょっとだけ違っている" と読める。diff ratioがが 96.0% とか大きな値になることもあり得ます。きっと何かエラーが発生した印でしょう。

diff ratioの次にある `png` というのは、link:https://github.com/kazurayam/materialstore/blob/main/src/main/java/com/kazurayam/materialstore/core/filesystem/FileType.java[FileType] つまりファイルの種類を表す記号です。`png` はPNG画像ファイルを表し、`html` はHTMLテキストファイルを表します。

FileTypeの次に少し長い文字列が続きます。

[source,text]
----
{"step:"01", "profile":"ProductionEnv", "URL.host":"demoaut-mimic.kazurayam.com", "URL.path":"/", "URL.port":"80", "URL.protocol":"http"}
----

この文字列を link:https://github.com/kazurayam/materialstore/blob/main/src/main/java/com/kazurayam/materialstore/core/filesystem/QueryOnMetadata.java[Metadata] メタデータと呼びます。２つのスクリーショット画像と差分画像の組について付加された説明です。

Visual Inspectionのソフトウェアは特殊なファイルシステムを装備しています。そのファイルシステムをわたしは link:https://github.com/kazurayam/materialstore/tree/main/src/main/java/com/kazurayam/materialstore/core/filesystem[materialstore] と呼んでいます。`materialstore` を使えばWeb画面のスクリーンショットやHTMLソースに対してURLをはじめとする任意のメタデータを付与してローカルディスクに保存することができます。そしてメタデータをキーとして検索してファイルを取り出すことができます。materialstore はVisual Inspectionを実装するために設計された問題特化型データベースですです。



=== Chronos Diff

Visual InspectionはひとつのWebサイトのスクリーンショットを２回撮って前後の画面を見比べることができます。link:http://demoaut-mimic.kazurayam.com/[] というテスト用のURLを標的に前後比較をしたとき出力されたレポートが下記のものです。このURLの画面の中には現在時刻が表示されている（例えば `2022/12/19 1:5:8 UTC`）ので、スクリーンショットを2度に分けて撮れば微小ながら必ず差異が生じます。レポートが画像の差異をレポートしてくれていることを見てください。

- link:https://kazurayam.github.io/inspectus4katalon-sample-project/demo/store/CURA-20221213_080716.html[CURA 1回目]
- link:https://kazurayam.github.io/inspectus4katalon-sample-project/demo/store/CURA-20221213_080831.html[CURA 2回目]


次の図はこのレポートがどのような内部処理によって作成されたかを示しています。

image:https://kazurayam.github.io/inspectus4katalon-sample-project/diagrams/out/activity-chronosdiff-ja/activity-chronosdiff-ja.png[activity cura]

image:https://kazurayam.github.io/inspectus4katalon-sample-project/diagrams/out/chronos

=== Twins Diff: Webサイトの本番環境と開発環境を比較する

- [MyAdmin](https://kazurayam.github.io/inspectus4katalon-sample-project/demo/store/MyAdmin-20221213_080556.html)

前述したChronos DiffはひとつのWebサイトを違うタイミングで2回スナップショットしましたが、Twins Diffは違います。Twins Diffを実行する際にはwebサイトの本番環境と開発環境のようにURLの中のホスト名部分が違う２つのURLを与えます。例えば

* `http://myadmin.kazurayam.com/` (本番環境)
* `http://devadmin.kazurayam.com/` (開発環境)

のように。そしてサイトを構成するページのURLのパス部分を列挙したCSVファイルを与えます。例えば

[source,text]
----
include:../Include/data/MyAdmin/targetList.csv
----

のように。

Twins Diffは指定されたURLのホスト名とCSVファイルから読み取ったパス文字列を合成してURLを特定します。そしてそのURLをブラウザで開いてスクリーンショットを撮ります。URLのパス文字列が一致する画像どおしを比較して差分を求めレポートを作成します。


link:https://kazurayam.github.io/inspectus4katalon-sample-project/diagrams/out/activity-twinsdiff-ja/activity-twinsdiff-ja.png![activity twins]


=== Shootings

画像を比較して差分を求めるような高度な加工をせず、ただスクリーンショットを撮って、それを一覧表示したいだけ、という場合もありましょう。そのとき役立つツールもあります。

* link:https://kazurayam.github.io/inspectus4katalon-sample-project/demo/store/DuckDuckGo-20221213_080436.html[DuckDuckGo]

検索サービス link:https://duckduckgo.com/[DuckDuckGo] をブラウザで開き、キーワードとして "selenium" を指定して、関連するサイトの一覧を求める。web画面のスクリーンショットを取得してPNG画像としてローカルディスクに保存し、ついでにweb画面のHTMLソースコードも保存する。各画面のURLなどのメタ情報も記録する。ファイルの一覧を表示するHTMLを生成しました。


== Visual Inspectionを動かしてみよう

=== 環境を設定する

==== Katalon Studio - Standalone Editionをインストールする。

下記URLからKatalon Studioのバイナリをダウンロードすることができます。

* https://katalon.com/download

Standalone Editionは無償利用が可能ですから、わたしはStandalone Editionをお勧めします。

ダウンロードしたバイナリからKatalon Studioをどのフォルダにインストールするかに少し注意が必要です。あなたのWindowsログインユーザがREAD/WRITE権限をフルに持っているフォルダならどこでもOKです。たとえば `C:\Users\youName\Documents` フォルダの下とか。`C:\Program Files` の下にインストールすると場合によってはWRITE権限が不足なためエラーが起きる場合があります。

==== プロジェクトを作る

Standalone Edition


== 雑談

=== Visual Inspection とは何か

_Visual Inspection_ は人間がWebサイトの画面をブラウザで開いてたくさんのページを眺めて *どこかおかしなところはないか?* と目視で確認する、その作業をツールで自動化することを目的とするツールです。よく似た別の言葉 "Visual Testing" をキーワードにGoogle検索すると商用ソフトウェア製品やサービスがいくつも見つかります。例えば

* link:https://www.browserstack.com/guide/visual-testing-beginners-guide[browserstack]
* link:https://applitools.com/learn/concepts/visual-testing/[applitool]
* link:https://katalon.com/visual-testing[katalon's Visual Testing]

しかし Visual Inspection をGoogle検索しても何も出てきません。無理もない。わたしが「画面確認の自動化」をアルファベットで表記するために作った造語だから。

_Testing_ とはあらかじめ条件を特定しておき対象となるソフトウェアが期待通りに動作するかどうかを確認することと定義しましょう。いっぽう _Inspection 検査_ とはWebシステムが提供する画面をできるだけたくさん眺める。そして「おや、これは何だ？」と不審な箇所を発見することを目指します。InspectionはTestingとは違う目的を持っています。

=== Visual Inspectionは誰のためのツールか

link:https://qiita.com/[Qiita]の読者の大半は現役プログラマであり、ソフトウエアの開発を本職としている人たちでしょう。Visual Inspectionは彼らプロのためのツールではありません。IT系じゃない一般企業に就職した新人君が、上司から

>「ウチのこのWebサイトにおかしなところが無いかどうか、全部のページを目で見て確認してくれ。」

といわれた。そういう新人君は毎年何千人もいるだろう。Visual Inspectionはこうした新人君の作業を楽にするためのツールです。

新人君はまだプログラミングの訓練を受けていない、Webサイトを実現しているIT技術のこと（ReactとかSpringとか...）はわからない。新人君が配属された部署は、SIerが開発して納品したソフトウェアを受け取って、できるかぎり動作確認して、稼働環境に投入して、自社のWebサービスを継続的に運転していく責任がある。本番としてリリースした画面に問題があってサイト利用者から指摘されたら、さあ大変。新人君はそうならないように画面確認作業を繰り返す。しかし画面確認は正直いって面倒くさいし面白くない。せめて注目すべき箇所を見つけ出すぐらいのことは自動化したい。・・・Visual Inspectionはこの新人君のためのツールです。


=== Visual Inspectionと商用製品・サービスとの違い

==== 自社のデータを社外に出すことの是非

Katalon Studioにも link:https://katalon.com/visual-testing[Visual Testing] のサービスが組み込まれています。このサービスはテストが生成したファイルをインターネット経由でKatalon社のサービスへ出力しサーバサイドで画像比較とレポート出力をするという形を取ります。わたしが各社のwebサイトの説明を読んだかぎりApplitoolsをはじめとするVisual Testingサービスは皆同じでした。ユーザーが所属する企業が社内情報が漏洩するリスクを嫌って自社データを社外に出力することを禁止している場合、商用のVisual Testingサービスを導入するのは無理です。

いっぽうわたしの開発したVisual Inspecton for Katalon StudioはあなたのPCの上で完結します。結果として生成したファイルをローカルディスクに出力するにとどまります。テストが生成したファイルをインターネット経由で他社が管理するクラウドストレージに出力することを必須としません。だから企業の情報セキュリティの壁を崩す心配がありません。

==== データ転送にかかる時間

一つのwebサイトを画面確認しようとして200画面分スクリーンショットを撮ったとします。Visual Inspection for Katalon StudioはPNGファイルをローカルディスクに保存して処理するので、さほど時間はかかりません。いっぽう商用サービスは多数の画像ファイルをPCからリモートのサーバーへネットワーク経由で転送します。あたなが使えるネットワークの速度に依存しますが、画像ファイルを転送するためだけに何分も時間がかかるであろうことは予想できます。

==== Chronos DiffはよそにもあるがTwins Diffはここだけ

わたしのツールはChronos DiffとTwins Diffの2通りの比較方式をサポートしています。

Chronos Diffとは、一つのURLについて時間間隔をおいて二度スナップショットを撮ったものを比較します。あなたのwebシステムの本番環境のスナップショットを午後１５時に取得し、入替等の作業をしてから、午後１６時にもう一度同じ環境のスナップショットをとる、そして作業の前後を比較して不慮のミスを犯していないかどうかを確認するような使い方ができます。

image:https://kazurayam.github.io/inspectus4katalon-sample-project/diagrams/out/activity-chronosdiff-ja/activity-chronosdiff-ja.png[activity ChronosDiff]

いっぽうTwins Diffとはあなたのwebシステムが2つの環境を持っていてトップページのURLのホスト名だけが違っているとして、2つの環境のスナップショットをほぼ同じタイミングで取得し、二つのスナップショット画像をうまく突き合わせて比較する、という目的に向いています。例えば 本番環境 `myadmin.kazurayam.com` と 開発環境 `devadmin.kazurayam.com` を比較することができます。元となるURLのホスト名が同一ではないスナップショットを*うまく突き合わせ*て組にするためのルールを組み立てる必要があって、ちょっと複雑にならざるを得ないのですが、わたしのツールはサポートしています。

image:https://kazurayam.github.io/inspectus4katalon-sample-project/diagrams/out/activity-twinsdiff-ja/activity-twinsdiff-ja.png[activity TwinsDiff]()


世の中のVisual Testing製品が実現しているのは、わたしのツールがChronos Diffと呼んでいるものだけです。**Twins Diffを実現している製品はわたしの見るところ他にありません。**

=== オープンソース、無償利用可能であること

Visual Inspectionはわたしが開発したオープンソースのソフトウェアライブラリ2つによって実装されています。

. link:https://github.com/kazurayam/materialstore[kazurayam/materialstore]
. link:https://github.com/kazurayam/inspectus[kazurayam/inspectus]


これらはApache2ライセンスを適用しており無償で利用可能です。従ってVisual Inspectionもオープンソースであり無償で利用可能です。


=== Katalon Studioが必須ではない

今回紹介したデモは link:https://katalon.com/download[Katalon Studio]を使って、Katalon Studioのプロジェクトとして作成しました。しかし上記に示したライブラリ(materialstoreとinspectus)はKatalon StudioのAPIにまったく依存していません。だからKatalon Studio無しでVisual Inspectionのプロジェクトを構成することができます。Java8 + Gradle + Selenium WebDriver で構成したVisual Inspectionプロジェクトの例が下記にあります。

. link:https://github.com/kazurayam/inspectus4selenium-sample-project[]

こちらのプロジェクトを説明するのはまた別の機会に。

